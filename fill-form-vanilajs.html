<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Form Editor (Vanilla JS)</title>
    <script src="https://unpkg.com/pdf-lib@1.11.0"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        .container {
            display: flex;
            gap: 20px;
        }

        #pdfViewer {
            flex: 1;
            height: 700px;
        }

        .form-controls {
            width: 300px;
            padding: 20px;
            background: #f5f5f5;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <iframe id="pdfViewer" width="100%" height="100%"></iframe>
        <div class="form-controls">
            <div class="form-group">
                <label>Full name:</label>
                <input type="text" id="FullName">
            </div>
            <div class="form-group">
                <label>ID:</label>
                <input type="text" id="ID" maxlength="10">
            </div>
            <div class="form-group">
                <label>Gender:</label>
                <input type="radio" name="Gender" value="Male"> Male
                <input type="radio" name="Gender" value="Female"> Female
            </div>
            <div class="form-group">
                <label>Married:</label>
                <input type="checkbox" id="Married">
            </div>
            <div class="form-group">
                <label>City:</label>
                <input type="text" id="City">
            </div>
            <div class="form-group">
                <label>Language:</label>
                <select id="Language">
                    <option value="English">English</option>
                    <option value="German">German</option>
                    <option value="French">French</option>
                    <option value="Italian">Italian</option>
                </select>
            </div>
            <button id="logFormData">Log Form Data</button>
        </div>
    </div>

    <script>
        let pdfDoc;
        // let existingPdfBytes;

        async function getThaiFont() {
            const fontUrl = 'tahoma.ttf'; // ต้องใส่ path ให้ถูก
            return await fetch(fontUrl).then(res => res.arrayBuffer());
        }

        async function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        async function displayPDF(pdfPath) {
            try {
                const existingPdfBytes = await fetch(pdfPath).then(res => res.arrayBuffer());
                pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

                pdfDoc.registerFontkit(window.fontkit);
                const thaiFontBytes = await getThaiFont();
                const customFont = await pdfDoc.embedFont(thaiFontBytes, { subset: false });

                const form = pdfDoc.getForm();
                setFieldValue(form);

                form.updateFieldAppearances(customFont);
                renderPDF();
            } catch (error) {
                console.error('Error loading PDF:', error);
            }
        }

        async function updatePDF() {
            try {
                const existingPdfBytes = await fetch('fill-form.pdf').then(res => res.arrayBuffer());
                pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

                pdfDoc.registerFontkit(window.fontkit);
                const thaiFontBytes = await getThaiFont();
                const customFont = await pdfDoc.embedFont(thaiFontBytes, { subset: false });

                const form = pdfDoc.getForm();
                setFieldValue(form);

                form.updateFieldAppearances(customFont);
                renderPDF();
            } catch (error) {
                console.error('Error updating PDF:', error);
            }
        }

        function setFieldValue(form) {
            form.getTextField('FullName').setText(document.getElementById('FullName').value || '');
            form.getTextField('FullName').enableReadOnly();
        }

        async function renderPDF() {
            const pdfBytes = await pdfDoc.save();
            const base64String = await arrayBufferToBase64(pdfBytes);
            document.getElementById('pdfViewer').src = `data:application/pdf;base64,${base64String}`;
        }

        function logFormData() {
            console.log('Form Data:', {
                FullName: document.getElementById('FullName').value,
                ID: document.getElementById('ID').value,
                Gender: document.querySelector('input[name="Gender"]:checked')?.value || '',
                Married: document.getElementById('Married').checked,
                City: document.getElementById('City').value,
                Language: document.getElementById('Language').value
            });
        }

        // document.addEventListener('DOMContentLoaded', () => {
        //     displayPDF('fill-form.pdf');

        //     document.getElementById('FullName').addEventListener('input', updatePDF);
        //     document.getElementById('ID').addEventListener('input', updatePDF);
        //     document.querySelectorAll('input[name="Gender"]').forEach(el => el.addEventListener('change', updatePDF));
        //     document.getElementById('Married').addEventListener('change', updatePDF);
        //     document.getElementById('City').addEventListener('input', updatePDF);
        //     document.getElementById('Language').addEventListener('change', updatePDF);
        //     document.getElementById('logFormData').addEventListener('click', logFormData);
        // });
    </script>
</body>

</html>